version: "2"
services:
  rabbitmq:
    build: .docker/rabbitmq
    hostname: recia-notification-poc-1
    ports:
      - "15671:15671"
      - "15672:15672"
      - "15674:15674"
      - "25672:25672"
      - "4369:4369"
      - "5671:5671"
      - "5672:5672"
    volumes:
      - "rabbitmq:/var/lib/rabbitmq"
      - "rabbitmq-plugins:/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.14/plugins"
      - "rabbitmq-configuration:/etc/rabbitmq"
  auth-service:
    image: maven
    volumes:
      - ".:/usr/src/app"
      - "m2repository:/root/.m2/repository"
    working_dir: "/usr/src/app/notification-poc-auth-service"
    command: mvn spring-boot:run -Drun.profiles=docker
    ports:
      - "8080:8080"
    depends_on:
      - auth-db
  auth-db:
    image: postgres:9.6
    environment:
      - POSTGRES_PASSWORD=postgres
    ports:
      - "12432:5432"
  node:
    build:
      context: .docker/node
      args:
        - GROUP_ID=${GROUP_ID}
        - USER_ID=${USER_ID}
    working_dir: /app
    volumes:
      - .:/home/node/app
      - node-cache:/.cache
  apache:
    build:
      context: .docker/apache
    volumes:
      - ".docker/apache/config/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro"
    ports:
      - "8088:80"
  elasticsearch:
    build:
      context: .docker/elasticsearch
      args:
        ELK_VERSION: $ELK_VERSION
    volumes:
      - .docker/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - elasticsearch:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      ES_JAVA_OPTS: "-Xmx256m -Xms256m"
  logstash:
    build:
      context: .docker/logstash
      args:
        - GROUP_ID=${GROUP_ID}
        - USER_ID=${USER_ID}
      args:
        ELK_VERSION: $ELK_VERSION
    volumes:
      - .docker/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml
      - .docker/logstash/pipeline:/usr/share/logstash/pipeline
    ports:
      - "5000:5000"
    environment:
      LS_JAVA_OPTS: "-Xmx256m -Xms256m"
    depends_on:
      - elasticsearch
  kibana:
    build:
      context: .docker/kibana
      args:
        ELK_VERSION: $ELK_VERSION
    volumes:
      - .docker/kibana/config/:/usr/share/kibana/config
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
volumes:
  rabbitmq: ~
  rabbitmq-plugins: ~
  rabbitmq-configuration: ~
  node-cache: ~
  elasticsearch: ~
  m2repository: ~